{% extends 'base.html' %}
{% load static %}

{% block title %}

{{ title }} - Pawsitive Care{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">
          <i class="fas fa-{% if object %}edit{% else %}plus{% endif %} text-primary me-2"></i>
          {{ title }}
        </h1>
        <a href="{% if object %}{% url 'inventory:item_detail' object.pk %}{% else %}{% url 'inventory:item_list' %}{% endif %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card">
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- Basic Information -->
            <fieldset class="mb-4">
              <legend class="h5 text-primary border-bottom pb-2 mb-3">
                <i class="fas fa-info-circle me-2"></i>Basic Information
              </legend>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.name.id_for_label }}" class="form-label">
                    {{ form.name.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.name }}
                  {% if form.name.errors %}
                  <div class="text-danger small">
                    {{ form.name.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                  <label for="{{ form.sku.id_for_label }}" class="form-label">
                    {{ form.sku.label }}
                  </label>
                  {{ form.sku }}
                  <div class="form-text">Leave blank to auto-generate</div>
                  {% if form.sku.errors %}
                  <div class="text-danger small">
                    {{ form.sku.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.category.id_for_label }}" class="form-label">
                    {{ form.category.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.category }}
                  {% if form.category.errors %}
                  <div class="text-danger small">
                    {{ form.category.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                  <label for="{{ form.unit.id_for_label }}" class="form-label">
                    {{ form.unit.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.unit }}
                  {% if form.unit.errors %}
                  <div class="text-danger small">
                    {{ form.unit.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>

              <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">
                  {{ form.description.label }}
                </label>
                {{ form.description }}
                {% if form.description.errors %}
                <div class="text-danger small">
                  {{ form.description.errors.0 }}
                </div>
                {% endif %}
              </div>
            </fieldset>

            <!-- Pricing and Stock -->
            <fieldset class="mb-4">
              <legend class="h5 text-success border-bottom pb-2 mb-3">
                <i class="fas fa-dollar-sign me-2"></i>Pricing and Stock
              </legend>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="{{ form.cost_price.id_for_label }}" class="form-label">
                    {{ form.cost_price.label }} <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.cost_price }}
                  </div>
                  {% if form.cost_price.errors %}
                  <div class="text-danger small">
                    {{ form.cost_price.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-4 mb-3">
                  <label for="{{ form.selling_price.id_for_label }}" class="form-label">
                    {{ form.selling_price.label }} <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.selling_price }}
                  </div>
                  {% if form.selling_price.errors %}
                  <div class="text-danger small">
                    {{ form.selling_price.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-4 mb-3">
                  <label for="{{ form.quantity.id_for_label }}" class="form-label">
                    {{ form.quantity.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.quantity }}
                  {% if form.quantity.errors %}
                  <div class="text-danger small">
                    {{ form.quantity.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.low_stock_threshold.id_for_label }}" class="form-label">
                    {{ form.low_stock_threshold.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.low_stock_threshold }}
                  <div class="form-text">Alert when stock falls below this level</div>
                  {% if form.low_stock_threshold.errors %}
                  <div class="text-danger small">
                    {{ form.low_stock_threshold.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                  <label for="{{ form.expiry_date.id_for_label }}" class="form-label">
                    {{ form.expiry_date.label }}
                  </label>
                  {{ form.expiry_date }}
                  <div class="form-text">Leave blank if item doesn't expire</div>
                  {% if form.expiry_date.errors %}
                  <div class="text-danger small">
                    {{ form.expiry_date.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </fieldset>

            <!-- Supplier Information -->
            <fieldset class="mb-4">
              <legend class="h5 text-info border-bottom pb-2 mb-3">
                <i class="fas fa-truck me-2"></i>Supplier Information
              </legend>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ form.supplier_name.id_for_label }}" class="form-label">
                    {{ form.supplier_name.label }}
                  </label>
                  {{ form.supplier_name }}
                  {% if form.supplier_name.errors %}
                  <div class="text-danger small">
                    {{ form.supplier_name.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                  <label for="{{ form.supplier_contact.id_for_label }}" class="form-label">
                    {{ form.supplier_contact.label }}
                  </label>
                  {{ form.supplier_contact }}
                  {% if form.supplier_contact.errors %}
                  <div class="text-danger small">
                    {{ form.supplier_contact.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </fieldset>

            <!-- Status -->
            <fieldset class="mb-4">
              <legend class="h5 text-secondary border-bottom pb-2 mb-3">
                <i class="fas fa-toggle-on me-2"></i>Status
              </legend>

              <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                  {{ form.is_active.label }}
                </label>
                <div class="form-text">Uncheck to deactivate this item</div>
                {% if form.is_active.errors %}
                <div class="text-danger small">
                  {{ form.is_active.errors.0 }}
                </div>
                {% endif %}
              </div>
            </fieldset>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between">
              <a href="{% if object %}{% url 'inventory:item_detail' object.pk %}{% else %}{% url 'inventory:item_list' %}{% endif %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                {% if object %}Update Item{% else %}Create Item{% endif %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Auto-calculate profit margin
  document.addEventListener('DOMContentLoaded', function() {
    const costPrice = document.getElementById('{{ form.cost_price.id_for_label }}');
    const sellingPrice = document.getElementById('{{ form.selling_price.id_for_label }}');

    function updateProfitMargin() {
      const cost = parseFloat(costPrice.value) || 0;
      const selling = parseFloat(sellingPrice.value) || 0;

      if (cost > 0 && selling > 0) {
        const margin = ((selling - cost) / selling * 100).toFixed(2);

        // Remove existing margin display
        const existingMargin = document.getElementById('profit-margin');
        if (existingMargin) {
          existingMargin.remove();
        }

        // Add new margin display
        const marginDiv = document.createElement('div');
        marginDiv.id = 'profit-margin';
        marginDiv.className = 'form-text';
        marginDiv.innerHTML = `Profit margin: ${margin}%`;

        if (margin < 0) {
          marginDiv.className += ' text-danger';
        } else if (margin < 10) {
          marginDiv.className += ' text-warning';
        } else {
          marginDiv.className += ' text-success';
        }

        sellingPrice.parentNode.appendChild(marginDiv);
      }
    }

    costPrice.addEventListener('input', updateProfitMargin);
    sellingPrice.addEventListener('input', updateProfitMargin);

    // Calculate on page load if values exist
    updateProfitMargin();
  });
</script>
{% endblock %}