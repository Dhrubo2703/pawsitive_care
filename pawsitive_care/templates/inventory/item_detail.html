{% extends 'base.html' %}
{% load static %}

{% block title %}

{{ title }} - Pawsitive Care{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="fas fa-box text-primary me-2"></i>
            {{ item.name }}
          </h1>
          <p class="text-muted mb-0">SKU:
            {{ item.sku }}
          </p>
        </div>
        <div>
          <a href="{% url 'inventory:item_edit' item.pk %}" class="btn btn-secondary me-2">
            <i class="fas fa-edit"></i> Edit
          </a>
          <a href="{% url 'inventory:update_stock' item.pk %}" class="btn btn-primary">
            <i class="fas fa-boxes"></i> Update Stock
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Item Status Alerts -->
  <div class="row mb-4">
    <div class="col-12">
      {% if item.is_out_of_stock %}
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="fas fa-times-circle me-2"></i>
        <div>
          <strong>Out of Stock!</strong> This item needs immediate restocking.
        </div>
      </div>
      {% elif item.is_low_stock %}
      <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <div>
          <strong>Low Stock Alert!</strong> Only
          {{ item.quantity }} units remaining.
        </div>
      </div>
      {% endif %}

      {% if item.is_expiring_soon %}
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="fas fa-clock me-2"></i>
        <div>
          <strong>Expiring Soon!</strong> This item expires on
          {{ item.expiry_date }}.
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Item Details -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle text-primary me-2"></i>
            Item Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>Name:</strong></td>
                  <td>
                    {{ item.name }}
                  </td>
                </tr>
                <tr>
                  <td><strong>SKU:</strong></td>
                  <td><code>
                      {{ item.sku }}</code></td>
                </tr>
                <tr>
                  <td><strong>Category:</strong></td>
                  <td>
                    <span class="badge bg-secondary">
                      {{ item.get_category_display }}</span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Current Stock:</strong></td>
                  <td>
                    <span class="{% if item.is_low_stock %}text-warning{% elif item.is_out_of_stock %}text-danger{% else %}text-success{% endif %}">
                      <strong>
                        {{ item.quantity }}
                        {{ item.get_unit_display }}</strong>
                    </span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Low Stock Threshold:</strong></td>
                  <td>
                    {{ item.low_stock_threshold }}
                    {{ item.get_unit_display }}
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>Cost Price:</strong></td>
                  <td>$
                    {{ item.cost_price }}
                  </td>
                </tr>
                <tr>
                  <td><strong>Selling Price:</strong></td>
                  <td>$
                    {{ item.selling_price }}
                  </td>
                </tr>
                <tr>
                  <td><strong>Total Value:</strong></td>
                  <td><strong>$
                      {{ item.calculate_total_value|floatformat:2 }}</strong></td>
                </tr>
                <tr>
                  <td><strong>Expiry Date:</strong></td>
                  <td>
                    {% if item.expiry_date %}
                    {{ item.expiry_date }}
                    {% if item.is_expiring_soon %}
                    <span class="badge bg-danger ms-2">Expiring Soon</span>
                    {% endif %}
                    {% else %}
                    <span class="text-muted">No expiry date</span>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td><strong>Last Restocked:</strong></td>
                  <td>
                    {% if item.last_restocked %}
                    {{ item.last_restocked|date:"M d, Y H:i" }}
                    {% else %}
                    <span class="text-muted">Never</span>
                    {% endif %}
                  </td>
                </tr>
              </table>
            </div>
          </div>

          {% if item.description %}
          <div class="mt-3">
            <strong>Description:</strong>
            <p class="mt-2">
              {{ item.description }}
            </p>
          </div>
          {% endif %}

          {% if item.supplier_name %}
          <div class="mt-3">
            <strong>Supplier Information:</strong>
            <div class="mt-2">
              <p class="mb-1"><strong>Name:</strong>
                {{ item.supplier_name }}
              </p>
              {% if item.supplier_contact %}
              <p class="mb-0"><strong>Contact:</strong>
                {{ item.supplier_contact }}
              </p>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Pricing Strategies Demo -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-calculator text-success me-2"></i>
            Pricing Examples
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-3">
            Real-time pricing examples using Strategy Design Pattern
          </p>

          <!-- Standard Pricing -->
          <div class="mb-3">
            <h6 class="text-primary">
              <i class="fas fa-tag me-1"></i>Standard Pricing
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: $
                  {{ pricing_examples.standard.qty_1|floatformat:2 }}</small><br>
                <small>5 units: $
                  {{ pricing_examples.standard.qty_5|floatformat:2 }}</small><br>
                <small>10 units: $
                  {{ pricing_examples.standard.qty_10|floatformat:2 }}</small>
              </div>
              <div class="col-6">
                <small>25 units: $
                  {{ pricing_examples.standard.qty_25|floatformat:2 }}</small><br>
                <small>50 units: $
                  {{ pricing_examples.standard.qty_50|floatformat:2 }}</small>
              </div>
            </div>
          </div>

          <!-- Bulk Pricing -->
          <div class="mb-3">
            <h6 class="text-success">
              <i class="fas fa-boxes me-1"></i>Bulk Pricing <small class="text-success">(5-15% off)</small>
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: $
                  {{ pricing_examples.bulk.qty_1|floatformat:2 }}</small><br>
                <small>5 units: $
                  {{ pricing_examples.bulk.qty_5|floatformat:2 }}</small><br>
                <small>10 units: <span class="text-success">$
                    {{ pricing_examples.bulk.qty_10|floatformat:2 }}</span></small>
              </div>
              <div class="col-6">
                <small>25 units: <span class="text-success">$
                    {{ pricing_examples.bulk.qty_25|floatformat:2 }}</span></small><br>
                <small>50 units: <span class="text-success">$
                    {{ pricing_examples.bulk.qty_50|floatformat:2 }}</span></small>
              </div>
            </div>
          </div>

          <!-- Premium/VIP Pricing -->
          <div class="mb-3">
            <h6 class="text-warning">
              <i class="fas fa-crown me-1"></i>Premium Pricing <small class="text-warning">(15% off)</small>
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: <span class="text-warning">$
                    {{ pricing_examples.premium.qty_1|floatformat:2 }}</span></small><br>
                <small>5 units: <span class="text-warning">$
                    {{ pricing_examples.premium.qty_5|floatformat:2 }}</span></small><br>
                <small>10 units: <span class="text-warning">$
                    {{ pricing_examples.premium.qty_10|floatformat:2 }}</span></small>
              </div>
              <div class="col-6">
                <small>25 units: <span class="text-warning">$
                    {{ pricing_examples.premium.qty_25|floatformat:2 }}</span></small><br>
                <small>50 units: <span class="text-warning">$
                    {{ pricing_examples.premium.qty_50|floatformat:2 }}</span></small>
              </div>
            </div>
          </div>

          <!-- Membership Pricing -->
          <div class="mb-3">
            <h6 class="text-info">
              <i class="fas fa-id-card me-1"></i>Membership Pricing <small class="text-info">(12% off)</small>
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: <span class="text-info">$
                    {{ pricing_examples.membership.qty_1|floatformat:2 }}</span></small><br>
                <small>5 units: <span class="text-info">$
                    {{ pricing_examples.membership.qty_5|floatformat:2 }}</span></small><br>
                <small>10 units: <span class="text-info">$
                    {{ pricing_examples.membership.qty_10|floatformat:2 }}</span></small>
              </div>
              <div class="col-6">
                <small>25 units: <span class="text-info">$
                    {{ pricing_examples.membership.qty_25|floatformat:2 }}</span></small><br>
                <small>50 units: <span class="text-info">$
                    {{ pricing_examples.membership.qty_50|floatformat:2 }}</span></small>
              </div>
            </div>
          </div>

          <!-- Seasonal Pricing -->
          <div class="mb-3">
            <h6 class="text-secondary">
              <i class="fas fa-sun me-1"></i>Seasonal Pricing <small class="text-secondary">(10% summer discount)</small>
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: <span class="text-secondary">$
                    {{ pricing_examples.seasonal.qty_1|floatformat:2 }}</span></small><br>
                <small>5 units: <span class="text-secondary">$
                    {{ pricing_examples.seasonal.qty_5|floatformat:2 }}</span></small><br>
                <small>10 units: <span class="text-secondary">$
                    {{ pricing_examples.seasonal.qty_10|floatformat:2 }}</span></small>
              </div>
              <div class="col-6">
                <small>25 units: <span class="text-secondary">$
                    {{ pricing_examples.seasonal.qty_25|floatformat:2 }}</span></small><br>
                <small>50 units: <span class="text-secondary">$
                    {{ pricing_examples.seasonal.qty_50|floatformat:2 }}</span></small>
              </div>
            </div>
          </div>

          <!-- Clearance Pricing (if item has expiry date) -->
          {% if item.expiry_date and pricing_examples.clearance %}
          <div class="mb-3">
            <h6 class="text-danger">
              <i class="fas fa-percentage me-1"></i>Clearance Pricing <small class="text-danger">(30% off)</small>
            </h6>
            <div class="row">
              <div class="col-6">
                <small>1 unit: <span class="text-danger">$
                    {{ pricing_examples.clearance.qty_1|floatformat:2 }}</span></small><br>
                <small>5 units: <span class="text-danger">$
                    {{ pricing_examples.clearance.qty_5|floatformat:2 }}</span></small><br>
                <small>10 units: <span class="text-danger">$
                    {{ pricing_examples.clearance.qty_10|floatformat:2 }}</span></small>
              </div>
              <div class="col-6">
                <small>25 units: <span class="text-danger">$
                    {{ pricing_examples.clearance.qty_25|floatformat:2 }}</span></small><br>
                <small>50 units: <span class="text-danger">$
                    {{ pricing_examples.clearance.qty_50|floatformat:2 }}</span></small>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="mt-3 pt-3 border-top">
            <a href="{% url 'inventory:pricing_examples' %}" class="btn btn-sm btn-outline-info">
              <i class="fas fa-calculator me-1"></i>View All Pricing Strategies
            </a>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-bolt text-warning me-2"></i>
            Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{% url 'inventory:update_stock' item.pk %}" class="btn btn-primary">
              <i class="fas fa-boxes me-2"></i>Update Stock
            </a>
            <a href="{% url 'inventory:item_edit' item.pk %}" class="btn btn-secondary">
              <i class="fas fa-edit me-2"></i>Edit Item
            </a>
            <button type="button" class="btn btn-info" onclick="printItemLabel()">
              <i class="fas fa-print me-2"></i>Print Label
            </button>
            {% if user.is_admin %}
            <a href="{% url 'inventory:item_delete' item.pk %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this item?')">
              <i class="fas fa-trash me-2"></i>Delete Item
            </a>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Interactive Pricing Calculator -->
      <div class="mt-4">
        {% include 'inventory/widgets/pricing_calculator.html' %}
      </div>
    </div>
  </div>

  <!-- Recent Stock Movements -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-history text-info me-2"></i>
            Recent Stock Movements
          </h5>
        </div>
        <div class="card-body">
          {% if recent_movements %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Quantity</th>
                  <th>Old Stock</th>
                  <th>New Stock</th>
                  <th>Reason</th>
                  <th>User</th>
                </tr>
              </thead>
              <tbody>
                {% for movement in recent_movements %}
                <tr>
                  <td>
                    {{ movement.created_at|date:"M d, Y H:i" }}
                  </td>
                  <td>
                    <span class="badge {% if movement.movement_type == 'IN' %}bg-success{% else %}bg-danger{% endif %}">
                      {{ movement.get_movement_type_display }}
                    </span>
                  </td>
                  <td>
                    {% if movement.movement_type == 'IN' %}+{% else %}-{% endif %}
                    {{ movement.quantity }}
                  </td>
                  <td>
                    {{ movement.old_quantity }}
                  </td>
                  <td>
                    {{ movement.new_quantity }}
                  </td>
                  <td>
                    {{ movement.reason }}
                  </td>
                  <td>
                    {% if movement.created_by %}
                    {{ movement.created_by.username }}
                    {% else %}
                    <span class="text-muted">System</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-3">
            <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No stock movements recorded yet</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function printItemLabel() {
    const printContent = `
        <div style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">
            <h2>{{ item.name }}</h2>
            <p><strong>SKU:</strong> {{ item.sku }}</p>
            <p><strong>Category:</strong> {{ item.get_category_display }}</p>
            <p><strong>Price:</strong> ${{ item.selling_price }}</p>
            {% if item.expiry_date %}
                <p><strong>Expires:</strong> {{ item.expiry_date }}</p>
            {% endif %}
        </div>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head><title>Item Label - {{ item.name }}</title></head>
            <body>${printContent}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
</script>
{% endblock %}