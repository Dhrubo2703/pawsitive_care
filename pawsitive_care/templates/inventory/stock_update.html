{% extends 'base.html' %}
{% load static %}

{% block title %}Update Stock -

{{ item.name }} - Pawsitive Care{% endblock %}

{% block extra_css %}
<style>
  .stock-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .current-stock {
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .stock-operation {
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: none;
    transition: all 0.3s ease;
  }

  .stock-operation:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .quick-action-btn {
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-add {
    background: linear-gradient(135deg, #28a745, #20c997);
    border-color: #28a745;
  }

  .btn-remove {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
    border-color: #dc3545;
  }

  .btn-adjust {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    border-color: #ffc107;
    color: #000;
  }

  .operation-card {
    border-left: 4px solid var(--operation-color);
    transition: all 0.3s ease;
  }

  .operation-card.add {
    --operation-color: #28a745;
  }

  .operation-card.remove {
    --operation-color: #dc3545;
  }

  .operation-card.adjust {
    --operation-color: #ffc107;
  }

  .stock-preview {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
  }

  .stock-preview.active {
    border-color: #007bff;
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
  }

  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .item-info-card {
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    border-radius: 12px;
    border: 1px solid #e9ecef;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Enhanced Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="stock-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h3 mb-2">
                <i class="fas fa-boxes me-2"></i>
                Update Stock Level
              </h1>
              <p class="mb-0 opacity-75">
                Manage inventory levels for this item
              </p>
            </div>
            <div class="col-md-4 text-md-end">
              <a href="{% url 'inventory:item_detail' item.pk %}" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Item
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column - Item Information -->
    <div class="col-lg-4 mb-4">

      <!-- Current Stock Status -->
      <div class="item-info-card">
        <div class="card-body p-4">
          <h5 class="card-title text-primary mb-3">
            <i class="fas fa-info-circle me-2"></i>Item Information
          </h5>

          <div class="mb-3">
            <h6 class="fw-bold">
              {{ item.name }}
            </h6>
            <p class="text-muted mb-1">SKU:
              {{ item.sku }}
            </p>
            <p class="text-muted mb-0">Category:
              {{ item.get_category_display }}
            </p>
          </div>

          <div class="text-center py-3">
            <div class="current-stock 
              {% if item.quantity_in_stock <= 0 %}text-danger
              {% elif item.quantity_in_stock <= item.minimum_stock_level %}text-warning
              {% else %}text-success{% endif %}">
              {{ item.quantity_in_stock }}
            </div>
            <p class="text-muted mb-2">
              {{ item.get_unit_display }} in stock
            </p>

            {% if item.quantity_in_stock <= 0 %}
            <span class="status-badge bg-danger text-white">
              <i class="fas fa-times-circle me-1"></i>Out of Stock
            </span>
            {% elif item.quantity_in_stock <= item.minimum_stock_level %}
            <span class="status-badge bg-warning text-dark">
              <i class="fas fa-exclamation-triangle me-1"></i>Low Stock
            </span>
            {% else %}
            <span class="status-badge bg-success text-white">
              <i class="fas fa-check-circle me-1"></i>In Stock
            </span>
            {% endif %}
          </div>

          <hr>

          <div class="row text-center">
            <div class="col-6">
              <small class="text-muted d-block">Minimum Level</small>
              <strong>
                {{ item.minimum_stock_level }}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Reorder Point</small>
              <strong>
                {{ item.reorder_point }}</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card mt-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-bolt text-warning me-2"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-add quick-action-btn" onclick="setOperation('add', 10)">
              <i class="fas fa-plus me-2"></i>Add 10 units
            </button>
            <button class="btn btn-add quick-action-btn" onclick="setOperation('add', 50)">
              <i class="fas fa-plus me-2"></i>Add 50 units
            </button>
            <button class="btn btn-remove quick-action-btn" onclick="setOperation('remove', 10)">
              <i class="fas fa-minus me-2"></i>Remove 10 units
            </button>
            <button class="btn btn-adjust quick-action-btn" onclick="setToMinimum()">
              <i class="fas fa-level-up-alt me-2"></i>Set to Minimum
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column - Stock Operations -->
    <div class="col-lg-8">

      <!-- Stock Operation Form -->
      <div class="card stock-operation">
        <div class="card-body p-4">
          <h5 class="card-title text-primary mb-4">
            <i class="fas fa-edit me-2"></i>Stock Operation
          </h5>

          <form method="post" id="stockForm">
            {% csrf_token %}

            <div class="row">
              <div class="col-md-6 mb-4">
                <label for="{{ form.operation_type.id_for_label }}" class="form-label fw-bold">
                  <i class="fas fa-cog me-2"></i>Operation Type
                </label>
                {{ form.operation_type }}
                {% if form.operation_type.errors %}
                <div class="text-danger small mt-1">
                  {{ form.operation_type.errors.0 }}
                </div>
                {% endif %}
              </div>

              <div class="col-md-6 mb-4">
                <label for="{{ form.quantity_change.id_for_label }}" class="form-label fw-bold">
                  <i class="fas fa-hashtag me-2"></i>Quantity
                </label>
                {{ form.quantity_change }}
                <div class="form-text">
                  <i class="fas fa-info-circle text-primary"></i>
                  Enter the amount to add, remove, or adjust to
                </div>
                {% if form.quantity_change.errors %}
                <div class="text-danger small mt-1">
                  {{ form.quantity_change.errors.0 }}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="mb-4">
              <label for="{{ form.reason.id_for_label }}" class="form-label fw-bold">
                <i class="fas fa-comment me-2"></i>Reason for Change
              </label>
              {{ form.reason }}
              <div class="form-text">
                <i class="fas fa-lightbulb text-warning"></i>
                Provide a brief explanation for this stock change
              </div>
              {% if form.reason.errors %}
              <div class="text-danger small mt-1">
                {{ form.reason.errors.0 }}
              </div>
              {% endif %}
            </div>

            <!-- Stock Preview -->
            <div id="stockPreview" class="stock-preview p-4 mb-4" style="display: none;">
              <h6 class="fw-bold mb-3">
                <i class="fas fa-eye me-2"></i>Preview Changes
              </h6>
              <div id="previewContent"></div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between align-items-center">
              <a href="{% url 'inventory:item_detail' item.pk %}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-times me-2"></i>Cancel
              </a>

              <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>Update Stock
              </button>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('stockForm');
    const operationSelect = document.getElementById('id_operation_type');
    const quantityInput = document.getElementById('id_quantity_change');
    const reasonTextarea = document.getElementById('id_reason');
    const previewDiv = document.getElementById('stockPreview');
    const previewContent = document.getElementById('previewContent');
    const submitBtn = document.getElementById('submitBtn');

    // Current item data
    const currentStock = {{ item.quantity_in_stock }};
    const minStock = {{ item.minimum_stock_level }};
    const reorderPoint = {{ item.reorder_point }};
    const unit = '{{ item.get_unit_display }}';

    // Update preview when inputs change
    function updatePreview() {
      const operation = operationSelect.value;
      const quantity = parseInt(quantityInput.value) || 0;

      if (!operation || quantity === 0) {
        previewDiv.style.display = 'none';
        return;
      }

      let newStock = currentStock;
      let operationText = '';
      let operationIcon = '';
      let operationColor = '';

      switch (operation) {
        case 'add':
          newStock = currentStock + quantity;
          operationText = `Adding ${quantity} ${unit}`;
          operationIcon = 'fas fa-plus-circle';
          operationColor = 'text-success';
          break;
        case 'remove':
          newStock = currentStock - quantity;
          operationText = `Removing ${quantity} ${unit}`;
          operationIcon = 'fas fa-minus-circle';
          operationColor = 'text-danger';
          break;
        case 'adjust':
          newStock = quantity;
          operationText = `Setting stock to ${quantity} ${unit}`;
          operationIcon = 'fas fa-edit';
          operationColor = 'text-primary';
          break;
      }

      // Determine new stock status
      let statusClass = 'text-success';
      let statusText = 'Good Level';
      let statusIcon = 'fas fa-check-circle';
      let warningMessage = '';

      if (newStock <= 0) {
        statusClass = 'text-danger';
        statusText = 'Out of Stock';
        statusIcon = 'fas fa-times-circle';
        if (operation === 'remove') {
          warningMessage = '⚠️ Warning: This will create negative stock!';
        }
      } else if (newStock <= minStock) {
        statusClass = 'text-warning';
        statusText = 'Below Minimum';
        statusIcon = 'fas fa-exclamation-triangle';
        warningMessage = `⚠️ Stock will be below minimum level (${minStock})`;
      } else if (newStock <= reorderPoint) {
        statusClass = 'text-info';
        statusText = 'Reorder Soon';
        statusIcon = 'fas fa-info-circle';
        warningMessage = `ℹ️ Stock will be at reorder point (${reorderPoint})`;
      }

      // Special validation for remove operation
      if (operation === 'remove' && quantity > currentStock) {
        warningMessage = `❌ Insufficient stock! Available: ${currentStock}, Requested: ${quantity}`;
        statusClass = 'text-danger';
        statusText = 'Insufficient Stock';
        statusIcon = 'fas fa-times-circle';
      }

      previewContent.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center ${operationColor}">
                        <i class="${operationIcon} me-2"></i>
                        <strong>${operationText}</strong>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="text-end">
                        <span class="text-muted">Current: ${currentStock} → </span>
                        <strong class="${statusClass}">New: ${newStock} ${unit}</strong>
                    </div>
                </div>
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center p-3 rounded" style="background: rgba(0,123,255,0.1);">
                        <span class="fw-bold">New Status:</span>
                        <span class="${statusClass}">
                            <i class="${statusIcon} me-1"></i>${statusText}
                        </span>
                    </div>
                    ${warningMessage ? `<div class="alert alert-warning mt-2 mb-0 py-2"><small>${warningMessage}</small></div>` : ''}
                </div>
            </div>
        `;

      previewDiv.style.display = 'block';
      previewDiv.classList.add('active');

      // Update submit button
      if (newStock < 0 || (operation === 'remove' && quantity > currentStock)) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Cannot Complete Operation';
        submitBtn.className = 'btn btn-danger btn-lg';
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Stock';
        submitBtn.className = 'btn btn-primary btn-lg';
      }
    }

    // Event listeners
    operationSelect.addEventListener('change', updatePreview);
    quantityInput.addEventListener('input', updatePreview);

    // Form submission
    form.addEventListener('submit', function() {
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
      submitBtn.disabled = true;
    });

    // Global functions for quick actions
    window.setOperation = function(operation, quantity) {
      operationSelect.value = operation;
      quantityInput.value = quantity;
      updatePreview();

      // Add visual feedback
      quantityInput.classList.add('is-valid');
      setTimeout(() => quantityInput.classList.remove('is-valid'), 2000);
    };

    window.setToMinimum = function() {
      const difference = minStock - currentStock;
      if (difference > 0) {
        setOperation('add', difference);
      } else {
        setOperation('adjust', minStock);
      }

      reasonTextarea.value = 'Restocking to minimum level';
    };

    // Operation type styling
    operationSelect.addEventListener('change', function() {
      const card = document.querySelector('.stock-operation');
      card.classList.remove('add', 'remove', 'adjust');

      if (this.value) {
        card.classList.add(this.value);
      }
    });

    // Auto-focus quantity input when operation is selected
    operationSelect.addEventListener('change', function() {
      if (this.value) {
        quantityInput.focus();
      }
    });
  });
</script>
{% endblock %}